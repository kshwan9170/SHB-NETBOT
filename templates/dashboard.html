<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHB-NetBot 대시보드</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Bootstrap CSS 추가 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 메인 콘텐츠 상단 여백 조정 */
        .container.my-5 {
            margin-top: 100px !important;
        }
    </style>
</head>
<body>
    <!-- 고정 내비게이션 바 -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <img src="{{ url_for('static', filename='images/shinhan_logo_new.png') }}" alt="신한은행 로고" class="logo-img shinhan-logo-white">
                <span>신한은행</span>
                <span class="bot-name">SHB-NetBot</span>
            </div>
            <div class="nav-links">
                <a href="/#home" class="nav-link">Home</a>
                <a href="/#about" class="nav-link">About</a>
                <a href="/#chat" class="nav-link">Chat</a>
                <a href="/#documents" class="nav-link">Documents</a>
                <a href="/dashboard" class="nav-link active">Dashboard</a>
                <a href="/#support" class="nav-link">Support</a>
                <button id="theme-toggle" class="theme-toggle">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </div>
            <div class="mobile-menu-btn" id="mobile-menu-btn">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
    </nav>



    <div class="container my-5">
        <!-- 헤더 영역 -->
        <div class="text-center mb-5">
            <h1 class="display-4" style="color: #30507A; font-family: 'Inter', sans-serif; font-weight: 600;">SHB-NetBot 대시보드</h1>
            <p class="lead" style="color: #5A6373; font-family: 'Inter', sans-serif; font-weight: 400;">실시간 사용자 문의 및 통계 분석</p>
        </div>
    
    <!-- 필터 영역 (숨김 처리, 기능 유지) -->
    <div class="card mb-4 shadow-sm filter-card" style="display: none; border-color: #E6EBF4;">
        <div class="card-body">
            <div class="d-flex align-items-center mb-3">
                <i class="fas fa-filter fa-2x me-3" style="color: #30507A;"></i>
                <div>
                    <h5 class="card-title mb-1" style="color: #30507A; font-family: 'Inter', sans-serif; font-weight: 600;">조회 필터</h5>
                    <small class="text-muted">기간 및 카테고리 설정</small>
                </div>
            </div>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <label for="period-select" class="form-label filter-label" style="font-family: 'Inter', sans-serif; font-weight: 500;">기간</label>
                    <select id="period-select" class="form-select filter-select" style="font-family: 'Inter', sans-serif; font-weight: 400;">
                        <option value="all" selected>전체 기간</option>
                        <option value="day">오늘</option>
                        <option value="week">최근 7일</option>
                        <option value="month">최근 30일</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="category-select" class="form-label filter-label" style="font-family: 'Inter', sans-serif; font-weight: 500;">카테고리</label>
                    <select id="category-select" class="form-select filter-select" style="font-family: 'Inter', sans-serif; font-weight: 400;">
                        <option value="" selected>전체 카테고리</option>
                        <!-- 카테고리 옵션은 JavaScript로 동적 생성 -->
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <button id="refresh-button" class="btn btn-primary w-100 filter-button" style="background-color: #30507A; border-color: #30507A; font-family: 'Inter', sans-serif; font-weight: 500;">
                        <i class="fas fa-sync-alt me-2"></i> 새로고침
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 통계 요약 카드 -->
    <div class="row mb-4">
        <!-- 전체 질문 수 -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm queries-card" style="border-color: #E6EBF4; cursor: pointer; transition: all 0.3s ease;" onclick="showQueriesDetails()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(48, 80, 122, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: #30507A;">총 질문 횟수</h5>
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-comments fa-3x me-3" style="color: #30507A;"></i>
                        <div class="display-4 fw-bold" id="total-queries">0</div>
                    </div>
                    <div class="small text-muted">서로 다른 질문 개수 (클릭하여 상세보기)</div>
                </div>
            </div>
        </div>
        
        <!-- 최근 방문자 -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm visitor-card" style="border-color: #E6EBF4; cursor: pointer; transition: all 0.3s ease;" onclick="openVisitorModal()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(48, 80, 122, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: #30507A;">최근 방문자</h5>
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-users fa-3x me-3" id="visitors-icon" style="color: #17a2b8;"></i>
                        <div class="display-4 fw-bold" id="recent-visitors">0</div>
                    </div>
                    <div class="small text-muted" id="visitors-description">지난 24시간 (클릭하여 상세보기)</div>
                </div>
            </div>
        </div>
        
        <!-- 사용자 만족도 -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm satisfaction-card" style="border-color: #E6EBF4; cursor: pointer; transition: all 0.3s ease;" onclick="showSatisfactionDetails()" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 20px rgba(255, 193, 7, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: #30507A;">사용자 만족도</h5>
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-smile fa-3x me-3" style="color: #ffc107;"></i>
                        <div>
                            <div class="display-4 fw-bold" id="positive-percentage">0%</div>
                            <small class="text-muted" id="positive-count-display">0건 (클릭하여 상세보기)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 주요 문의 TOP 10 차트 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm top-queries-chart-card" style="border-color: #E6EBF4;">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-chart-bar fa-2x me-3" style="color: #30507A;"></i>
                        <div>
                            <h5 class="card-title mb-1" style="color: #30507A; font-family: 'Inter', sans-serif; font-weight: 600;">주요 문의 TOP 10</h5>
                            <small class="text-muted">실시간 인기 질문 순위</small>
                        </div>
                    </div>
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="top-queries-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- 푸터 섹션 -->
<footer class="footer">
    <div class="footer-container">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>서비스</h3>
                    <div class="footer-links">
                        <a href="#home" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            홈
                        </a>
                        <a href="#about" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            소개
                        </a>
                        <a href="#chat" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            대화하기
                        </a>
                        <a href="#documents" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            문서
                        </a>
                    </div>
                </div>
                <div class="footer-col">
                    <h3>고객지원</h3>
                    <div class="footer-links">
                        <a href="/inquiry" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            문의하기
                        </a>
                        <a href="/feedback" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                            </svg>
                            피드백
                        </a>
                        <a href="/report" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            신고하기
                        </a>
                        <a href="#dashboard" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            </svg>
                            대시보드
                        </a>
                    </div>
                </div>
                <div class="footer-col">
                    <h3>정보</h3>
                    <div class="footer-links">
                        <a href="/terms" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            이용약관
                        </a>
                        <a href="/privacy" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            개인정보처리방침
                        </a>
                        <a href="/copyright" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M15 9.354a4 4 0 1 0 0 5.292"></path>
                            </svg>
                            저작권
                        </a>
                        <a href="/security" class="footer-link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            보안정책
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 신한은행. All rights reserved.</p>
        </div>
    </div>
</footer>

<!-- 방문자 상세 정보 모달 -->
<div class="modal fade" id="visitorDetailsModal" tabindex="-1" aria-labelledby="visitorDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #30507A;">
                <h5 class="modal-title text-white" id="visitorDetailsModalLabel">
                    <i class="fas fa-users me-2"></i>방문자 상세 정보
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card text-center" style="border-color: #E6EBF4;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #30507A;">총 고유 IP</h6>
                                <div class="h4 mb-0" id="total-unique-ips">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center" style="border-color: #E6EBF4;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #30507A;">총 방문 수</h6>
                                <div class="h4 mb-0" id="total-visit-count">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center" style="border-color: #E6EBF4;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #30507A;">조회 기간</h6>
                                <div class="h6 mb-0">지난 24시간</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IP별 통계 테이블 -->
                <div class="card mb-3" style="border-color: #E6EBF4;">
                    <div class="card-header" style="background-color: #F8F9FA;">
                        <h6 class="mb-0" style="color: #30507A;">
                            <i class="fas fa-chart-bar me-2"></i>IP별 방문 통계
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="ip-stats-table">
                                <thead style="background-color: #F8F9FA;">
                                    <tr>
                                        <th style="color: #30507A;">IP 주소</th>
                                        <th style="color: #30507A;">방문 횟수</th>
                                        <th style="color: #30507A;">방문 페이지</th>
                                        <th style="color: #30507A;">최초 방문</th>
                                        <th style="color: #30507A;">최근 방문</th>
                                    </tr>
                                </thead>
                                <tbody id="ip-stats-tbody">
                                    <!-- 데이터 로딩 중 -->
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm" role="status"></div>
                                            데이터 로딩 중...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 최근 방문 기록 -->
                <div class="card" style="border-color: #E6EBF4;">
                    <div class="card-header" style="background-color: #F8F9FA;">
                        <h6 class="mb-0" style="color: #30507A;">
                            <i class="fas fa-clock me-2"></i>최근 방문 기록 (최대 50개)
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="visitor-records-table">
                                <thead style="background-color: #F8F9FA;">
                                    <tr>
                                        <th style="color: #30507A;">시간</th>
                                        <th style="color: #30507A;">IP 주소</th>
                                        <th style="color: #30507A;">방문 페이지</th>
                                    </tr>
                                </thead>
                                <tbody id="visitor-records-tbody">
                                    <!-- JavaScript로 채워짐 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="refreshVisitorData()" style="background-color: #30507A; border-color: #30507A;">
                    <i class="fas fa-sync-alt me-2"></i>새로고침
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 사용자 만족도 상세 정보 모달 -->
<div class="modal fade" id="satisfactionDetailsModal" tabindex="-1" aria-labelledby="satisfactionDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #ffc107;">
                <h5 class="modal-title text-white" id="satisfactionDetailsModalLabel">
                    <i class="fas fa-chart-pie me-2"></i>사용자 만족도 상세 분석
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 통계 요약 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center" style="border-color: #E6EBF4;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #30507A;">전체 피드백</h6>
                                <div class="h4 mb-0" id="total-feedback-count">-</div>
                                <small class="text-muted">최근 30일</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center" style="border-color: #E6EBF4; border-left: 4px solid #28a745;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #28a745;">만족해요</h6>
                                <div class="h4 mb-0" id="positive-feedback-count">-</div>
                                <small class="text-muted" id="positive-percentage-detail">0%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center" style="border-color: #E6EBF4; border-left: 4px solid #dc3545;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #dc3545;">개선필요</h6>
                                <div class="h4 mb-0" id="negative-feedback-count">-</div>
                                <small class="text-muted" id="negative-percentage-detail">0%</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center" style="border-color: #E6EBF4;">
                            <div class="card-body">
                                <h6 class="card-title" style="color: #30507A;">만족도</h6>
                                <div class="h4 mb-0" id="satisfaction-rate-detail">-</div>
                                <small class="text-muted">전체 평균</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 일별 추이 차트 -->
                <div class="card mb-4" style="border-color: #E6EBF4;">
                    <div class="card-header" style="background-color: #F8F9FA;">
                        <h6 class="mb-0" style="color: #30507A;">
                            <i class="fas fa-chart-line me-2"></i>일별 피드백 추이 (최근 7일)
                        </h6>
                    </div>
                    <div class="card-body">
                        <canvas id="feedbackTrendChart" height="100"></canvas>
                    </div>
                </div>

                <div class="row">
                    <!-- 개선필요 피드백 -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border-color: #E6EBF4; border-left: 4px solid #dc3545;">
                            <div class="card-header" style="background-color: #F8F9FA;">
                                <h6 class="mb-0" style="color: #dc3545;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>최근 개선필요 피드백 (최대 20개)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead style="background-color: #F8F9FA; position: sticky; top: 0;">
                                            <tr>
                                                <th style="color: #30507A;">시간</th>
                                                <th style="color: #30507A;">질문 내용</th>
                                                <th style="color: #30507A; width: 80px;">작업</th>
                                            </tr>
                                        </thead>
                                        <tbody id="negative-feedback-tbody">
                                            <tr>
                                                <td colspan="3" class="text-center">
                                                    <div class="spinner-border spinner-border-sm" role="status"></div>
                                                    데이터 로딩 중...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 만족 피드백 -->
                    <div class="col-md-6">
                        <div class="card h-100" style="border-color: #E6EBF4; border-left: 4px solid #28a745;">
                            <div class="card-header" style="background-color: #F8F9FA;">
                                <h6 class="mb-0" style="color: #28a745;">
                                    <i class="fas fa-thumbs-up me-2"></i>최근 만족 피드백 (최대 20개)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-sm table-hover">
                                        <thead style="background-color: #F8F9FA; position: sticky; top: 0;">
                                            <tr>
                                                <th style="color: #30507A;">시간</th>
                                                <th style="color: #30507A;">질문 내용</th>
                                            </tr>
                                        </thead>
                                        <tbody id="positive-feedback-tbody">
                                            <!-- JavaScript로 채워짐 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="refreshSatisfactionData()" style="background-color: #ffc107; border-color: #ffc107; color: #000;">
                    <i class="fas fa-sync-alt me-2"></i>새로고침
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 필수 라이브러리 -->
<script defer src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- AOS 애니메이션 -->
<script defer src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script>
  AOS.init();
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 차트 객체 (초기화 후 나중에 업데이트)
    let topQueriesChart;
    
    // 페이지 로드시 데이터 조회
    refreshDashboard();
    
    // 부정 피드백 카드 초기화
    updateNegativeFeedbackCard();
    




    // 함수는 전역으로 이동됨

    // 호환성을 위한 showVisitorModal 함수 (openVisitorModal로 리다이렉트)
    function showVisitorModal() {
        openVisitorModal();
    }
    
    // 전역으로도 등록
    window.showVisitorModal = showVisitorModal;

    // 방문자 수 안전하게 업데이트
    (function() {
        try {
            fetch('/api/feedback_stats')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success && typeof data.unique_visitors_24h === 'number') {
                        const visitorElement = document.getElementById('recent-visitors');
                        if (visitorElement) {
                            visitorElement.innerText = data.unique_visitors_24h;
                            console.log('방문자 수 업데이트:', data.unique_visitors_24h);
                        }
                    }
                })
                .catch(() => {}); // 오류 무시
        } catch(e) {
            // 오류 무시
        }
    })();
    
    // 새로고침 버튼 클릭 이벤트
    document.getElementById('refresh-button').addEventListener('click', refreshDashboard);
    
    // 필터 변경 이벤트
    document.getElementById('period-select').addEventListener('change', refreshDashboard);
    document.getElementById('category-select').addEventListener('change', refreshDashboard);
    
    // 대시보드 데이터 조회 및 업데이트 함수
    function refreshDashboard() {
        // 로딩 표시 (필요시 구현)
        
        // 필터 값 가져오기
        const period = document.getElementById('period-select').value;
        const category = document.getElementById('category-select').value;
        
        // API 호출
        fetch(`/api/top_queries?period=${period}&category=${category}&limit=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateDashboard(data);
                } else {
                    console.error('데이터 조회 오류:', data.error);
                    // 에러 메시지 표시 (필요시 구현)
                }
            })
            .catch(error => {
                console.error('API 호출 오류:', error);
                // 에러 메시지 표시 (필요시 구현)
            });
    }
    
    // 대시보드 UI 업데이트 함수
    function updateDashboard(data) {
        // 카테고리 옵션 업데이트
        updateCategoryOptions(data.category_stats);
        
        // 통계 요약 업데이트
        updateSummaryStats(data);
        
        // 차트 업데이트
        updateTopQueriesChart(data.top_queries);
        
        // 테이블 업데이트
        updateQueryTable(data.top_queries);
        
        // 피드백 통계 업데이트 (새로운 기능)
        updateFeedbackStats();
    }
    
    // 카테고리 옵션 업데이트
    function updateCategoryOptions(categoryStats) {
        const categorySelect = document.getElementById('category-select');
        const currentValue = categorySelect.value;
        
        // 현재 카테고리 옵션 유지하면서 목록 업데이트
        // 첫 번째 옵션(전체 카테고리)는 유지
        while (categorySelect.options.length > 1) {
            categorySelect.remove(1);
        }
        
        // 카테고리 옵션 추가
        categoryStats.forEach(stat => {
            const option = document.createElement('option');
            option.value = stat.category;
            option.textContent = `${stat.category} (${stat.total_count})`;
            categorySelect.appendChild(option);
        });
        
        // 이전 선택 값 복원 (존재하는 경우)
        if (currentValue) {
            for (let i = 0; i < categorySelect.options.length; i++) {
                if (categorySelect.options[i].value === currentValue) {
                    categorySelect.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // 통계 요약 업데이트
    function updateSummaryStats(data) {
        // 총 질문 횟수 (실제 조회된 질문들의 count 합계)
        const totalCount = data.top_queries.reduce((sum, q) => sum + q.count, 0);
        document.getElementById('total-queries').textContent = totalCount;
        
        // 피드백 카드 업데이트 및 방문자 수 업데이트
        updateFeedbackCard();
        
        // 방문자 카드도 별도로 업데이트
        updateVisitorCard();
    }
    
    // 방문자 카드 업데이트 함수 (실제 API 데이터 사용)
    function updateVisitorCard() {
        fetch('/api/visitor_details')
            .then(response => response.json())
            .then(data => {
                if (data && data.success) {
                    const visitorsText = document.getElementById('recent-visitors');
                    const visitorsIcon = document.getElementById('visitors-icon');
                    const visitorsDescription = document.getElementById('visitors-description');
                    
                    if (visitorsText) {
                        // 실제 고유 IP 수 표시
                        const actualUniqueIPs = data.ip_statistics ? data.ip_statistics.length : 0;
                        visitorsText.textContent = actualUniqueIPs;
                        console.log('방문자 카드 업데이트 완료:', actualUniqueIPs);
                        
                        if (visitorsIcon) {
                            visitorsIcon.style.color = '#17a2b8'; // 방문자는 청록색
                        }
                        if (visitorsDescription) {
                            visitorsDescription.textContent = '지난 24시간 (클릭하여 상세보기)';
                        }
                    }
                } else {
                    console.log('방문자 데이터 로딩 실패');
                }
            })
            .catch(error => {
                console.log('방문자 데이터 로딩 중 오류:', error);
            });
    }
    
    // 피드백 카드 업데이트 함수 (간소화)
    function updateFeedbackCard() {
        // 피드백 데이터 API 호출
        fetch('/api/feedback_stats')
            .then(response => response.json())
            .then(feedbackData => {
                if (feedbackData.success) {
                    console.log('피드백 데이터 처리 중:', feedbackData);
                    
                    // 상단 카드의 사용자 만족도 업데이트
                    const total = (feedbackData.positive_count || 0) + (feedbackData.negative_count || 0);
                    const satisfactionRate = total > 0 ? Math.round((feedbackData.positive_count || 0) / total * 100) : 0;
                    
                    // 사용자 만족도 퍼센트 업데이트
                    const positivePercentageElement = document.getElementById('positive-percentage');
                    if (positivePercentageElement) {
                        positivePercentageElement.textContent = `${satisfactionRate}%`;
                    }
                    
                    // 사용자 만족도 건수 표시 추가
                    const positiveCountDisplayElement = document.getElementById('positive-count-display');
                    if (positiveCountDisplayElement) {
                        positiveCountDisplayElement.textContent = `${feedbackData.positive_count || 0}건 (클릭하여 상세보기)`;
                    }
                    
                    // 최근 방문자 수 업데이트 (방문자 API에서 실제 데이터 가져오기)
                    // updateVisitorCard(); // 중복 제거 - updateSummaryStats에서 이미 호출함
                } else {
                    console.log('피드백 데이터 로딩 실패:', feedbackData);
                }
            })
            .catch(error => {
                console.log('피드백 데이터 로딩 중 오류:', error);
            });
    }
    
    // 방문자 카드 업데이트 함수
    function updateVisitorCard() {
        console.log('방문자 카드 업데이트 시작');
        
        fetch('/api/visitor_details')
            .then(response => response.json())
            .then(data => {
                console.log('방문자 데이터 수신:', data);
                
                if (data.success) {
                    // 24시간 내 고유 방문자 수 업데이트
                    const uniqueVisitorsElement = document.getElementById('unique-visitors-24h');
                    if (uniqueVisitorsElement && data.total_unique_ips !== undefined) {
                        uniqueVisitorsElement.textContent = data.total_unique_ips;
                        console.log('방문자 카드 업데이트 완료:', data.total_unique_ips);
                    }
                } else {
                    console.log('방문자 데이터 로딩 실패:', data.error);
                }
            })
            .catch(error => {
                console.log('방문자 데이터 로딩 중 오류:', error);
            });
    }
    
    // 개선필요 피드백 카드 업데이트 함수
    function updateNegativeFeedbackCard() {
        console.log('개선필요 피드백 카드 업데이트 시작');
        // 이미 updateFeedbackCard()에서 처리하므로 별도 작업 불필요
        console.log('개선필요 피드백 카드 업데이트 완료');
    }

    // Top 쿼리 차트 업데이트
    function updateTopQueriesChart(topQueries) {
        const ctx = document.getElementById('top-queries-chart').getContext('2d');
        
        // 데이터 없음 처리
        if (topQueries.length === 0) {
            if (topQueriesChart) {
                topQueriesChart.destroy();
                topQueriesChart = null;
            }
            // 차트 영역에 '데이터 없음' 메시지 표시 (필요시 구현)
            return;
        }
        
        // 차트 데이터 준비
        const labels = topQueries.map(query => {
            // 질문이 너무 길면 잘라서 표시
            const maxLength = 30;
            return query.query_text.length > maxLength 
                ? query.query_text.substring(0, maxLength) + '...'
                : query.query_text;
        });
        
        const counts = topQueries.map(query => query.count);
        
        // 차트 설정
        const chartData = {
            labels: labels,
            datasets: [{
                label: '질문 횟수',
                data: counts,
                backgroundColor: 'rgba(48, 80, 122, 0.7)',
                borderColor: 'rgba(48, 80, 122, 1)',
                borderWidth: 1
            }]
        };
        
        const chartOptions = {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const idx = tooltipItems[0].dataIndex;
                            return topQueries[idx].query_text;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '질문 횟수'
                    }
                }
            }
        };
        
        // 차트 생성 또는 업데이트
        if (topQueriesChart) {
            topQueriesChart.data = chartData;
            topQueriesChart.options = chartOptions;
            topQueriesChart.update();
        } else {
            topQueriesChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: chartOptions
            });
        }
    }
    

});

// 모바일 메뉴 토글 기능
document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
    document.querySelector('.nav-links').classList.toggle('active');
    this.classList.toggle('active');
});

// 테마 토글 기능 (메인 페이지와 동일한 방식으로 수정)
document.getElementById('theme-toggle').addEventListener('click', function() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    
    // 아이콘 업데이트
    updateThemeIcon(newTheme);
});

// 테마 아이콘 업데이트 함수
function updateThemeIcon(theme) {
    const sunIcon = document.querySelector('.sun-icon');
    const moonIcon = document.querySelector('.moon-icon');
    
    if (theme === 'dark') {
        sunIcon.style.display = 'block';
        moonIcon.style.display = 'none';
    } else {
        sunIcon.style.display = 'none';
        moonIcon.style.display = 'block';
    }
}

// 페이지 로드 시 저장된 테마 적용
const savedTheme = localStorage.getItem('theme') || 'light';
document.documentElement.setAttribute('data-theme', savedTheme);
updateThemeIcon(savedTheme);

// 전역 날짜/시간 포맷팅 함수
function formatDateTime(timestamp) {
    if (!timestamp) return '시간 정보 없음';
    
    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return '유효하지 않은 날짜';
        
        return date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            timeZone: 'Asia/Seoul'
        });
    } catch (e) {
        console.log('날짜 변환 오류:', e);
        return '날짜 형식 오류';
    }
}

// 새로운 방문자 모달 함수
function openVisitorModal() {
    console.log('방문자 모달 열기 시작');
    
    // 모달 엘리먼트 찾기
    const modalElement = document.getElementById('visitorDetailsModal');
    if (!modalElement) {
        alert('방문자 모달을 찾을 수 없습니다.');
        return;
    }
    
    // 모달 표시
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // 로딩 상태 설정
    document.getElementById('total-unique-ips').textContent = '로딩...';
    document.getElementById('total-visit-count').textContent = '로딩...';
    
    const ipStatsBody = document.getElementById('ip-stats-tbody');
    const visitorRecordsBody = document.getElementById('visitor-records-tbody');
    
    ipStatsBody.innerHTML = '<tr><td colspan="5" class="text-center">데이터 로딩 중...</td></tr>';
    visitorRecordsBody.innerHTML = '<tr><td colspan="3" class="text-center">데이터 로딩 중...</td></tr>';
    
    // API 호출
    fetch('/api/visitor_details')
        .then(response => {
            console.log('API 응답 상태:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('방문자 데이터 수신:', data);
            
            if (data && data.success) {
                // 통계 업데이트 (방문자 모달 전용 - 다른 모달에 영향 없음)
                // IP 통계에서 실제 고유 IP 수 계산
                const actualUniqueIPs = data.ip_statistics ? data.ip_statistics.length : 0;
                document.getElementById('total-unique-ips').textContent = actualUniqueIPs;
                document.getElementById('total-visit-count').textContent = (data.visitor_records && data.visitor_records.length) || 0;
                
                // IP 통계 테이블 업데이트
                ipStatsBody.innerHTML = '';
                if (data.ip_statistics && data.ip_statistics.length > 0) {
                    data.ip_statistics.forEach(stat => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><code>${stat.ip}</code></td>
                            <td><span class="badge bg-primary">${stat.visit_count}</span></td>
                            <td><small>${stat.pages ? stat.pages.join(', ') : '알 수 없음'}</small></td>
                            <td><small>${formatDateTime(stat.first_visit)}</small></td>
                            <td><small>${formatDateTime(stat.last_visit)}</small></td>
                        `;
                        ipStatsBody.appendChild(row);
                    });
                } else {
                    ipStatsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">IP 통계가 없습니다.</td></tr>';
                }
                
                // 방문 기록 테이블 업데이트
                visitorRecordsBody.innerHTML = '';
                if (data.visitor_records && data.visitor_records.length > 0) {
                    data.visitor_records.slice(0, 50).forEach(record => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><small>${formatDateTime(record.timestamp)}</small></td>
                            <td><code>${record.ip}</code></td>
                            <td><small>${record.page}</small></td>
                        `;
                        visitorRecordsBody.appendChild(row);
                    });
                } else {
                    visitorRecordsBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">방문 기록이 없습니다.</td></tr>';
                }
            } else {
                // 오류 상태
                document.getElementById('total-unique-ips').textContent = '오류';
                document.getElementById('total-visit-count').textContent = '오류';
                ipStatsBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">데이터를 불러올 수 없습니다.</td></tr>';
                visitorRecordsBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">데이터를 불러올 수 없습니다.</td></tr>';
            }
        })
        .catch(error => {
            console.log('방문자 데이터 로드 중 문제 발생:', error);
            // 기본값으로 설정하여 오류 방지
            document.getElementById('total-unique-ips').textContent = '0';
            document.getElementById('total-visit-count').textContent = '0';
            ipStatsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">데이터를 다시 불러오는 중입니다...</td></tr>';
            visitorRecordsBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">데이터를 다시 불러오는 중입니다...</td></tr>';
            
            // 잠시 후 다시 시도
            setTimeout(() => {
                location.reload();
            }, 2000);
        });
}

// 사용자 만족도 상세 정보 모달 함수
function showSatisfactionDetails() {
    fetch('/api/satisfaction_details')
        .then(response => response.json())
        .then(data => {
            console.log('만족도 상세 데이터:', data);
            
            if (data.success) {
                // 통계 업데이트
                document.getElementById('total-feedback-count').textContent = data.statistics.total_count;
                document.getElementById('positive-feedback-count').textContent = data.statistics.positive_count;
                document.getElementById('negative-feedback-count').textContent = data.statistics.negative_count;
                document.getElementById('satisfaction-rate-detail').textContent = data.statistics.satisfaction_rate + '%';
                
                const totalCount = data.statistics.total_count;
                if (totalCount > 0) {
                    const positivePercent = Math.round((data.statistics.positive_count / totalCount) * 100);
                    const negativePercent = Math.round((data.statistics.negative_count / totalCount) * 100);
                    document.getElementById('positive-percentage-detail').textContent = `${positivePercent}%`;
                    document.getElementById('negative-percentage-detail').textContent = `${negativePercent}%`;
                }
                
                // 개선필요 피드백 테이블 업데이트
                const negativeTbody = document.getElementById('negative-feedback-tbody');
                negativeTbody.innerHTML = '';
                
                if (data.negative_feedback && data.negative_feedback.length > 0) {
                    data.negative_feedback.forEach(feedback => {
                        const row = document.createElement('tr');
                        const shortQuery = feedback.query.length > 50 ? 
                            feedback.query.substring(0, 50) + '...' : feedback.query;
                        const date = new Date(feedback.timestamp);
                        const formattedTime = date.toLocaleDateString('ko-KR') + ' ' + 
                            date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                        
                        row.innerHTML = `
                            <td><small>${formattedTime}</small></td>
                            <td title="${feedback.query}">${shortQuery}</td>
                            <td>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteFeedback(${feedback.id})" title="삭제">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        negativeTbody.appendChild(row);
                    });
                } else {
                    negativeTbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">개선필요 피드백이 없습니다.</td></tr>';
                }
                
                // 만족 피드백 테이블 업데이트  
                const positiveTbody = document.getElementById('positive-feedback-tbody');
                positiveTbody.innerHTML = '';
                
                if (data.positive_feedback && data.positive_feedback.length > 0) {
                    data.positive_feedback.forEach(feedback => {
                        const row = document.createElement('tr');
                        const shortQuery = feedback.query.length > 50 ? 
                            feedback.query.substring(0, 50) + '...' : feedback.query;
                        const date = new Date(feedback.timestamp);
                        const formattedTime = date.toLocaleDateString('ko-KR') + ' ' + 
                            date.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
                        
                        row.innerHTML = `
                            <td><small>${formattedTime}</small></td>
                            <td title="${feedback.query}">${shortQuery}</td>
                        `;
                        positiveTbody.appendChild(row);
                    });
                } else {
                    positiveTbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">만족 피드백이 없습니다.</td></tr>';
                }
                
                // 차트 생성
                createFeedbackTrendChart(data.daily_trends);
                
                // 모달 표시
                const modal = new bootstrap.Modal(document.getElementById('satisfactionDetailsModal'));
                modal.show();
            } else {
                console.error('만족도 상세 정보 로드 실패:', data.error);
                alert('만족도 상세 정보를 불러오는데 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('API 호출 오류:', error);
            alert('서버 연결에 문제가 발생했습니다.');
        });
}

// 피드백 추이 차트 생성
let feedbackChart = null;
function createFeedbackTrendChart(dailyTrends) {
    const ctx = document.getElementById('feedbackTrendChart').getContext('2d');
    
    // 기존 차트가 있으면 제거
    if (feedbackChart) {
        feedbackChart.destroy();
    }
    
    const labels = dailyTrends.map(trend => {
        const date = new Date(trend.date);
        return date.toLocaleDateString('ko-KR', {month: 'short', day: 'numeric'});
    });
    
    feedbackChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '만족해요',
                data: dailyTrends.map(trend => trend.positive),
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: '개선필요',
                data: dailyTrends.map(trend => trend.negative),
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

// 만족도 데이터 새로고침
function refreshSatisfactionData() {
    showSatisfactionDetails();
}

// 피드백 삭제 함수
function deleteFeedback(feedbackId) {
    if (confirm('이 피드백을 삭제하시겠습니까?')) {
        fetch('/api/delete_feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                feedback_id: feedbackId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('피드백이 성공적으로 삭제되었습니다.');
                // 만족도 상세 정보 다시 로드
                showSatisfactionDetails();
                // 대시보드 메인 카드도 업데이트
                updateFeedbackCard();
            } else {
                alert('피드백 삭제에 실패했습니다: ' + (data.error || '알 수 없는 오류'));
            }
        })
        .catch(error => {
            console.error('피드백 삭제 오류:', error);
            alert('피드백 삭제 중 오류가 발생했습니다: ' + error.message);
        });
    }
}

// 전체 질문 수 상세 정보 표시
function showQueriesDetails() {
    fetch('/api/top_queries?period=all&category=&limit=10')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('질문 데이터:', data); // 디버깅용
            if (data.success && data.top_queries) {
                const queries = data.top_queries.slice(0, 10); // TOP 10으로 제한
                
                // 카테고리별 통계 계산
                const categoryStats = {};
                queries.forEach(query => {
                    // 질문 내용을 기반으로 카테고리 스마트 매핑
                    let category = query.category || '일반';
                    const queryText = query.query_text.toLowerCase();
                    
                    if (queryText.includes('ip주소') || queryText.includes('ip 주소') || queryText.includes('아이피')) {
                        category = 'IP사용자조회';
                    } else if (queryText.includes('포티게이트') || queryText.includes('os 버전') || queryText.includes('장비') || queryText.includes('자산') || queryText.includes('모델명') || queryText.includes('벤더')) {
                        category = '자산관리';
                    } else if (queryText.includes('대외기관') || queryText.includes('대외계') || queryText.includes('연동') || queryText.includes('회선') || queryText.includes('기관')) {
                        category = '대외계연동';
                    } else if (queryText.includes('장애') || queryText.includes('오류') || queryText.includes('문제') || queryText.includes('안됨') || queryText.includes('안돼') || queryText.includes('실패') || queryText.includes('dgw') || queryText.includes('무선')) {
                        category = '장애문의';
                    } else if (queryText.includes('절차') || queryText.includes('방법') || queryText.includes('어떻게') || queryText.includes('프로세스') || queryText.includes('등록')) {
                        category = '절차안내';
                    } else {
                        category = '일반문의';
                    }
                    
                    if (!categoryStats[category]) {
                        categoryStats[category] = { count: 0, totalQueries: 0 };
                    }
                    categoryStats[category].count += 1;
                    categoryStats[category].totalQueries += query.count;
                });
                
                // 카테고리별 통계 HTML 생성
                const categoryStatsHtml = Object.entries(categoryStats)
                    .sort((a, b) => b[1].totalQueries - a[1].totalQueries)
                    .map(([category, stats]) => {
                        const percentage = ((stats.totalQueries / queries.reduce((sum, q) => sum + q.count, 0)) * 100).toFixed(1);
                        let badgeClass = 'bg-secondary';
                        
                        switch(category) {
                            case 'IP사용자조회': badgeClass = 'bg-info'; break;
                            case '자산관리': badgeClass = 'bg-success'; break;
                            case '대외계연동': badgeClass = 'bg-warning'; break;
                            case '장애문의': badgeClass = 'bg-danger'; break;
                            case '절차안내': badgeClass = 'bg-primary'; break;
                            default: badgeClass = 'bg-secondary';
                        }
                        
                        return `
                            <div class="col-md-4 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background-color: #f8f9fa;">
                                    <div class="d-flex align-items-center">
                                        <span class="badge ${badgeClass} me-2">${category}</span>
                                        <small>${stats.count}개 질문</small>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">${stats.totalQueries}회 (${percentage}%)</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                let modalContent = `
                    <div class="modal fade" id="queriesModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #30507A;">
                                    <h5 class="modal-title text-white">
                                        📊 전체 질문 상세 현황
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- 통계 요약 -->
                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="card text-center border-0" style="background-color: #f8f9fa;">
                                                <div class="card-body py-3">
                                                    <h6 class="card-title text-primary mb-1">총 질문 수</h6>
                                                    <h4 class="text-primary mb-0">${queries.length}건</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center border-0" style="background-color: #f8f9fa;">
                                                <div class="card-body py-3">
                                                    <h6 class="card-title text-success mb-1">총 질문 횟수</h6>
                                                    <h4 class="text-success mb-0">${queries.reduce((sum, q) => sum + q.count, 0)}회</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card text-center border-0" style="background-color: #f8f9fa;">
                                                <div class="card-body py-3">
                                                    <h6 class="card-title text-warning mb-1">최다 질문</h6>
                                                    <small class="text-warning">${queries.length > 0 ? queries[0].query_text.substring(0, 20) + (queries[0].query_text.length > 20 ? '...' : '') + ' (' + queries[0].count + '회)' : '데이터 없음'}</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 카테고리별 통계 -->
                                    <div class="row mb-4">
                                        <div class="col-12">
                                            <h6 class="mb-3">📊 카테고리별 질문 현황</h6>
                                            <div id="category-stats-container" class="row">
                                                ${categoryStatsHtml}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6 class="mb-3">📋 최근 질문 목록 (최신 50개)</h6>
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-striped table-hover">
                                            <thead style="background-color: #f8f9fa; position: sticky; top: 0;">
                                                <tr>
                                                    <th style="color: #30507A;">순위</th>
                                                    <th style="color: #30507A;">질문 내용</th>
                                                    <th style="color: #30507A;">카테고리</th>
                                                    <th style="color: #30507A;">횟수</th>
                                                    <th style="color: #30507A;">최근 질문 시간</th>
                                                </tr>
                                            </thead>
                                            <tbody>`;
                
                queries.forEach((query, index) => {
                    // 다양한 시간 필드명 확인하여 날짜 처리 (전체 질문 모달 전용)
                    let timestamp = '시간 정보 없음';
                    const timeField = query.latest_timestamp || query.last_asked || query.timestamp || query.last_timestamp;
                    
                    if (timeField) {
                        try {
                            const date = new Date(timeField);
                            if (!isNaN(date.getTime())) {
                                timestamp = date.toLocaleString('ko-KR', {
                                    year: 'numeric',
                                    month: '2-digit',
                                    day: '2-digit',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    timeZone: 'Asia/Seoul'
                                });
                            }
                        } catch (e) {
                            console.log('전체 질문 모달 날짜 변환 오류:', e);
                        }
                    }
                    
                    // 카테고리 추출 및 질문 내용 기반 스마트 매핑
                    let category = query.category || '일반';
                    let categoryBadgeClass = 'bg-secondary';
                    let categoryDisplay = category;
                    
                    // 질문 내용을 기반으로 카테고리 스마트 매핑
                    const queryText = query.query_text.toLowerCase();
                    if (queryText.includes('ip주소') || queryText.includes('ip 주소') || queryText.includes('아이피')) {
                        category = 'IP_사용자_조회';
                    } else if (queryText.includes('포티게이트') || queryText.includes('os 버전') || queryText.includes('장비') || queryText.includes('자산') || queryText.includes('모델명') || queryText.includes('벤더')) {
                        category = '자산';
                    } else if (queryText.includes('대외기관') || queryText.includes('대외계') || queryText.includes('연동') || queryText.includes('회선')) {
                        category = '대외계_연동';
                    } else if (queryText.includes('절차') || queryText.includes('등록') || queryText.includes('신청') || queryText.includes('승인')) {
                        category = '절차_안내';
                    } else if (queryText.includes('장애') || queryText.includes('오류') || queryText.includes('문제') || queryText.includes('안됨') || queryText.includes('보이지 않') || queryText.includes('접속 불가')) {
                        category = '장애_문의';
                    }
                    
                    // 카테고리별 표시 스타일 및 한글명 매핑
                    switch(category) {
                        case 'IP_사용자_조회':
                            categoryBadgeClass = 'bg-info';
                            categoryDisplay = 'IP사용자조회';
                            break;
                        case '절차_안내':
                            categoryBadgeClass = 'bg-warning';
                            categoryDisplay = '절차안내';
                            break;
                        case '대외계_연동':
                            categoryBadgeClass = 'bg-primary';
                            categoryDisplay = '대외계연동';
                            break;
                        case '장애_문의':
                            categoryBadgeClass = 'bg-danger';
                            categoryDisplay = '장애문의';
                            break;
                        case '자산':
                            categoryBadgeClass = 'bg-success';
                            categoryDisplay = '자산관리';
                            break;
                        default:
                            categoryBadgeClass = 'bg-secondary';
                            categoryDisplay = '일반';
                    }
                    
                    modalContent += `
                        <tr>
                            <td><span class="badge bg-primary">${index + 1}</span></td>
                            <td>${query.query_text}</td>
                            <td><span class="badge ${categoryBadgeClass}">${categoryDisplay}</span></td>
                            <td><span class="badge bg-success">${query.count}회</span></td>
                            <td><small class="text-muted">${timestamp}</small></td>
                        </tr>`;
                });
                
                modalContent += `
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                                    <button type="button" class="btn btn-primary" onclick="showQueriesDetails()" style="background-color: #30507A; border-color: #30507A;">
                                        🔄 새로고침
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                // 기존 모달 제거 후 새로 추가
                const existingModal = document.getElementById('queriesModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
                const modal = new bootstrap.Modal(document.getElementById('queriesModal'));
                modal.show();
            } else {
                console.log('질문 데이터 오류:', data);
                alert('질문 데이터를 불러오는데 실패했습니다: ' + (data.message || '알 수 없는 오류'));
            }
        })
        .catch(error => {
            console.error('질문 데이터 로딩 오류:', error);
            alert('서버 연결에 문제가 발생했습니다.');
        });
}

// 페이지 로드 시 방문자 카드 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 방문자 카드 즉시 업데이트
    setTimeout(updateVisitorCard, 1000); // 1초 후 실행
});

// 페이지가 완전히 로드된 후에도 실행
window.addEventListener('load', function() {
    setTimeout(updateVisitorCard, 500); // 0.5초 후 실행
});


</script>

<!-- Bootstrap JS 추가 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- AOS 애니메이션 라이브러리 -->
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<!-- 메인 페이지와 동일한 JavaScript 포함 -->
<script src="{{ url_for('static', filename='js/modern.js') }}"></script>
</body>
</html>